# GigaChat Agent

Веб-приложение для взаимодействия с API GigaChat с поддержкой защиты паролем, истории сообщений и контекстного взаимодействия.

## Возможности

- **Защита паролем**: Пароль устанавливается при первом запросе сессии и сохраняется на всё время работы
- **История сообщений**: Все сообщения пользователя и ответы агента отображаются в интерфейсе с временем отправки
- **Контекстное взаимодействие**: При отправке нового сообщения контекст включает последние 5 сообщений из истории
- **Управление сессиями сервера**: Каждая сессия севера имеет свой пароль
- **Управление сессиями браузера**: Каждая сессия браузера имеет свою историю
- **Безопасность**: Пароли хешируются с использованием SHA256 и уникального SALT
- **Интуитивный интерфейс**: Удобная панель для ввода сообщений с поддержкой многострочного текста

## Требования

- Python 3.8+
- FastAPI
- Uvicorn
- Requests
- Переменная окружения `GIGACHAT_TOKEN` с вашим Basic-ключом для OAuth авторизации

## Установка

1. Клонируйте репозиторий:
```bash
git clone <your-repo-url>
cd gigachat-agent
```

2. Установите зависимости:
```bash
pip install fastapi uvicorn requests
```

3. Установите переменную окружения:
```bash
export GIGACHAT_TOKEN="ваш_basic_key_здесь"
```

4. Запустите сервер:
```bash
python chat_server.py
```

5. Откройте браузер и перейдите на `http://localhost:8010/chat`

## Структура проекта

```
.
├── chat_server.py          # Основной backend на FastAPI
├── static/
│   └── index.html          # Фронтенд приложения
└── README.md               # Этот файл
```

## Использование

### Первый запуск

1. При открытии страницы вы увидите форму с полем для ввода пароля
2. Введите любой пароль в поле (минимум 1 символ)
3. Напишите сообщение в основное поле ввода
4. Нажмите **Enter** или кнопку "Отправить"
5. Пароль будет сохранён для текущей сессии, поле пароля заблокируется

### Клавиатурные команды

- **Enter** — отправить сообщение
- **Shift+Enter** — перенос строки в поле ввода

### Интерфейс

- **Основное поле** — отображает историю сообщений с временем отправки
- **Поле пароля** — вводится один раз при первом запросе
- **Счётчик ошибок** — показывает количество неправильных попыток ввода пароля
- **Статус** — выводит "✓ Success" при успешной аутентификации или сообщение об ошибке

## Архитектура

### Backend (Python)

```python
@app.post("/api/verify-and-ask")
```

Основной endpoint, который:
1. Получает сессию из cookies
2. При первом запросе устанавливает пароль (хешируется с SALT)
3. При последующих запросах проверяет пароль
4. Формирует контекст из последних 5 сообщений
5. Отправляет запрос в GigaChat API
6. Возвращает ответ агента

### Frontend (JavaScript)

- Управление историей сообщений
- Форматирование сообщений с именем отправителя и временем
- Обработка клавиатурных команд
- Отправка контекста на сервер

## Безопасность

### Хеширование пароля

- Каждая сессия получает уникальный SALT
- Пароль хешируется с SHA256: `hash = SHA256(password + salt)`
- Оригинальный пароль никогда не хранится в памяти
- Чувствителен к регистру

### Сессии

- Session ID хранится в защищённом httponly cookie
- Время жизни сессии: 24 часа
- Пароль сохраняется только в памяти сервера (теряется при перезагрузке)

## Конфигурация GigaChat API

### Получение токена

1. Перейдите на [developers.sber.ru](https://developers.sber.ru/studio/workspaces/my-space/get/gigachat-api)
2. Получите Basic-ключ для OAuth авторизации
3. Установите переменную окружения:
```bash
export GIGACHAT_TOKEN="your_basic_key"
```

### Модель

По умолчанию используется модель `GigaChat-2`. Для изменения отредактируйте параметр `model` в функции `verify_and_ask`:

```python
payload = {
    "model": "GigaChat-2",  # Измените здесь
    ...
}
```

## Примеры API запросов

### Успешный запрос

```bash
curl -X POST http://localhost:8010/api/verify-and-ask \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Привет! Как дела?",
    "password": "admin123",
    "history": []
  }'
```

Ответ:
```json
{
  "answer": "Привет! У меня всё хорошо. Чем я могу вам помочь?"
}
```

### Ошибка неправильного пароля

```json
{
  "error": "wrong_password"
}
```

## Логирование

Приложение выводит информацию об ошибках в консоль. Для подробного логирования отредактируйте уровень логирования в Uvicorn.

## Известные ограничения

- HTTPS не используется (используйте для продакшена!)
- История сообщений хранится только в памяти браузера (теряется при перезагрузке)
- Пароли сессии хранятся только в памяти сервера (теряются при перезагрузке)
- Максимальное количество одновременных пользователей ограничено памятью сервера

## Развёртывание в продакшене

### Рекомендации

1. **SSL/TLS**: Используйте реальные сертификаты (не self-signed)
2. **Reverse Proxy**: Разместите за Nginx или Apache
3. **Database**: Рассмотрите хранение историй в БД
4. **Authentication**: Добавьте двухфакторную аутентификацию
5. **Rate Limiting**: Ограничьте количество запросов в минуту
6. **Логирование**: Настройте централизованное логирование

### Пример конфигурации Nginx

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://127.0.0.1:8010;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### Запуск с Gunicorn

```bash
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker chat_server:app
```

## Отладка

### Включение debug режима

Отредактируйте последнюю строку в `chat_server.py`:

```python
uvicorn.run("chat_server:app", host="127.0.0.1", port=8010, reload=True, log_level="debug")
```

### Просмотр логов GigaChat API

Добавьте в функцию `verify_and_ask` после получения ответа:

```python
print(f"GigaChat response: {resp.status_code}")
print(f"Response data: {resp.json()}")
```

## Решение проблем

### Ошибка: "GIGACHAT_TOKEN не установлена"

```bash
export GIGACHAT_TOKEN="your_basic_key"
python chat_server.py
```

### Ошибка SSL при подключении к GigaChat

Это нормально для разработки. В `chat_server.py` используется `verify=False`. Для продакшена:

1. Установите CA-сертификаты: `pip install certifi`
2. Удалите `verify=False` из запросов к GigaChat

### Сессия теряется при перезагрузке сервера

Это ожидаемое поведение. История и пароли хранятся в памяти. Для сохранения добавьте БД (например, PostgreSQL или Redis).
